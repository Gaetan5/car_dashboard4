<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Dashboard</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Mapbox GL CSS -->
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.css' rel='stylesheet' />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
</head>
<body>
    <div class="dashboard">
        <div class="top-bar">
            <div class="battery">
                <i class="fas fa-battery-half"></i>
                <span id="batteryPercent">85%</span>
            </div>
            <div class="weather">
                <i class="fas fa-cloud-rain"></i>
                <span>Raining</span>
            </div>
            <div class="temp">
                <span>22°C</span>
            </div>
            <div class="date-time">
                <span>Sat 28 Aug 2021</span>
                <span>16:28</span>
            </div>
        </div>
        <div class="main-content">
            <!-- Debut de la Map Zone -->
            <div class="map">
                <input type="text" placeholder="Search your destination">
                <!-- Mapping et pointeur de direction -->
                <div id="map" class="map-display"></div>
                <!-- Localisation et en Emplacement en temps R -->
                <div class="location-info">
                    <span>No. 420, North Bridge Road, #05-03</span>
                    <span>15km - 30 minutes</span>
                </div>
            </div>
            <!--Fin de la Map Zone -->
            <!-- Contreuls de Navigation et Gestionnaire du car -->
            <div class="controls">
                <div class="welcome">
                    <i class="fas fa-user-circle"></i>
                    <span>Hi Kurnia Majid, can I help you?</span>
                </div>
                <div class="buttons">
                    <button><i class="fas fa-fan"></i><span>Air Conditioner</span></button>
                    <button><i class="fas fa-comments"></i><span>Messages</span></button>
                    <button><i class="fas fa-map-signs"></i><span>Navigation</span></button>
                    <button><i class="fas fa-music"></i><span>Music</span></button>
                    <button><i class="fas fa-charging-station"></i><span>Battery Station</span></button>
                    <button><i class="fas fa-phone"></i><span>Phone</span></button>
                </div>
                <div class="music-player">
                    <img src="muzik.jpg" alt="Album Art">
                    <div class="track-info">
                        <span>Starboy</span>
                        <span>4:56</span>
                        <span>Happier</span>
                        <span>7:48</span>
                        <span>Untitled</span>
                        <span>5:40</span>
                        <span>Hello</span>
                        <span>3:50</span>
                    </div>
                </div>
            </div>
            <div class="car-info">
                <div class="speed">
                    <span id="speedValue">156</span>
                    <span>km/h</span>
                </div>
                <div class="car-image">
                    <img src="https://via.placeholder.com/300" alt="Car">
                </div>
                <div class="battery-status">
                    <div id="batteryProgress" class="battery-progress"></div>
                    <span id="batteryLevel">32%</span>
                    <div class="distance">20 km Distance</div>
                </div>
            </div>
        </div>
    </div>
    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
    <script src="/static/js/newFile.1.js"></script>
    <script>
        // Initialisation de Mapbox
        mapboxgl.accessToken = 'pk.eyJ1IjoiaGFuczIxMDQiLCJhIjoiY2x3azJiMWZqMTF4OTJqcGYwajN3dDhhZSJ9.F91A-tc6Tau0jqgU4Tx08w';
        const map = new mapboxgl.Map({
            container: 'map', // ID du conteneur
            style: 'mapbox://styles/mapbox/outdoors-v11', // URL du style
            center: [103.851959, 1.290270], // Position initiale [longitude, latitude]
            zoom: 15.5, // Zoom initial
            pitch: 48.5, // Inclinaison de la carte
            bearing: -17.5 // Orientation de la carte
        });

        // Ajouter la couche de trafic
        map.on('load', () => {
            map.addLayer({
                id: 'traffic',
                type: 'line',
                source: {
                    type: 'vector',
                    url: 'mapbox://mapbox.mapbox-traffic-v1'
                },
                'source-layer': 'traffic',
                layout: {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                paint: {
                    'line-color': [
                        'case',
                        ['==', ['get', 'congestion'], 'low'], '#00ff00',
                        ['==', ['get', 'congestion'], 'moderate'], '#ffff00',
                        ['==', ['get', 'congestion'], 'heavy'], '#ff0000',
                        ['==', ['get', 'congestion'], 'severe'], '#800000',
                        '#00ff00' // Default color if no congestion data
                    ],
                    'line-width': 2
                }
            });
        });

        // Marqueurs de départ et d'arrivée (à modifier selon vos besoins)
        const startPoint = [103.851959, 1.290270];
        const endPoint = [103.8185, 1.3521];
        
        const startMarker = new mapboxgl.Marker({ color: 'green' })
            .setLngLat(startPoint)
            .setPopup(new mapboxgl.Popup().setText('Point de départ'))
            .addTo(map);

        const endMarker = new mapboxgl.Marker({ color: 'red' })
            .setLngLat(endPoint)
            .setPopup(new mapboxgl.Popup().setText('Point d\'arrivée'))
            .addTo(map);

        // Fonction pour calculer la distance entre deux points (en km)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Rayon de la Terre en km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Fonction pour obtenir des informations de localisation avec OpenCage
        async function getLocationInfo(lat, lon) {
            const apiKey = '6fbe06b1b8044fb18c9a61d3b703ee6d'; // Replace with your OpenCage API key
            const response = await fetch(`https://api.opencagedata.com/geocode/v1/json?q=${query}&key=${apiKey}`);
            const data = await response.json();
            if (data.results && data.results.length > 0) {
                return data.results[0].formatted;
            } else {
                return 'Location not found';
            }
        }

        // Fonction pour mettre à jour la position en temps réel
        async function updatePosition(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            // Obtenir des informations de localisation
            const locationInfo = await getLocationInfo(lat, lon);

            // Marqueur de la position actuelle
            if (!map.currentPositionMarker) {
                map.currentPositionMarker = new mapboxgl.Marker({ color: 'blue' })
                    .setLngLat([lon, lat])
                    .addTo(map)
                    .on('click', () => {
                        map.zoomTo(map.getZoom() * 1.3, { duration: 1000 });
                    });
            } else {
                map.currentPositionMarker.setLngLat([lon, lat]);
            }

            // Mettre à jour la vue de la carte
            map.setCenter([lon, lat]);

            // Calculer les distances
            const distanceToStart = calculateDistance(lat, lon, startPoint[1], startPoint[0]);
            const distanceToEnd = calculateDistance(lat, lon, endPoint[1], endPoint[0]);

            // Afficher les distances et les informations de localisation
            document.querySelector('.location-info').innerHTML = `
                <span>position: [${lat.toFixed(5)}, ${lon.toFixed(5)}]</span>
                <span>départ: ${distanceToStart.toFixed(2)} km</span>
                <span>d'arrivée: ${distanceToEnd.toFixed(2)} km</span>
                <span>Location: ${locationInfo}</span>
            `;
        }

        // Vérifier si la géolocalisation est disponible
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(updatePosition, (error) => {
                console.error('Erreur de géolocalisation:', error);
            }, {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            });
        } else {
            console.error('La géolocalisation n\'est pas supportée par ce navigateur.');
        }
        document.getElementById('searchInput').addEventListener('input', async (event) => {
            const query = event.target.value;
            if (query.length > 3) {
                const results = await searchLocation(query);
                displaySearchResults(results);
            }
        });
    </script>
</body>
</html>
