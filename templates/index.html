<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Dashboard</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.css' rel='stylesheet' />
</head>
<body>
    <div class="dashboard">
        <div class="top-bar">
            <div class="battery">
                <i class="fas fa-battery-half"></i>
                <span id="batteryPercent">85%</span>
            </div>
            <div class="weather">
                <i class="fas fa-cloud-rain"></i>
                <span>Raining</span>
            </div>
            <div class="temp">
                <span>22Â°C</span>
            </div>
            <div class="date-time">
                <span>Sat 28 Aug 2021</span>
                <span>16:28</span>
            </div>
        </div>
        <div class="main-content">
            <div class="map">
                <input type="text" id="searchInput" placeholder="Search your destination">
                <div id="searchResults" class="search-results"></div>
                <div id="map" class="map-display"></div>
                <div class="location-info">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Votre position</span>
                </div>
            </div>
            <div class="controls">
                <div class="welcome">
                    <i class="fas fa-user-circle"></i>
                    <span>Hi Kurnia Majid, can I help you?</span>
                </div>
                <div class="buttons">
                    <button><i class="fas fa-fan"></i><span>Air Conditioner</span></button>
                    <button><i class="fas fa-comments"></i><span>Messages</span></button>
                    <button><i class="fas fa-map-signs"></i><span>Navigation</span></button>
                    <button><i class="fas fa-music"></i><span>Music</span></button>
                    <button><i class="fas fa-charging-station"></i><span>Battery Station</span></button>
                    <button><i class="fas fa-phone"></i><span>Phone</span></button>
                </div>
                <div class="music-player">
                    <img src="muzik.jpg" alt="Album Art">
                    <div class="track-info">
                        <span>Starboy</span>
                        <span>4:56</span>
                        <span>Happier</span>
                        <span>7:48</span>
                        <span>Untitled</span>
                        <span>5:40</span>
                        <span>Hello</span>
                        <span>3:50</span>
                    </div>
                </div>
            </div>
            <div class="car-info">
                <div class="speed">
                    <span id="speedValue">156</span>
                    <span>km/h</span>
                </div>
                <div class="car-image">
                    <img src="https://via.placeholder.com/300" alt="Car">
                </div>
                <div class="battery-status">
                    <div id="batteryProgress" class="battery-progress"></div>
                    <span id="batteryLevel">32%</span>
                    <div class="distance">20 km Distance</div>
                </div>
            </div>
        </div>
    </div>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        // Initialize Mapbox
        mapboxgl.accessToken = 'pk.eyJ1IjoiaGFuczIxMDQiLCJhIjoiY2x3azJiMWZqMTF4OTJqcGYwajN3dDhhZSJ9.F91A-tc6Tau0jqgU4Tx08w';
        const map = new mapboxgl.Map({
            container: 'map', // container ID
            style: 'mapbox://styles/mapbox/streets-v11', // style URL
            center: [103.851959, 1.290270], // starting position [lng, lat]
            zoom: 12 // starting zoom
        });

        // Add marker for current position
        const marker = new mapboxgl.Marker()
            .setLngLat([103.851959, 1.290270]) // coordinates for the marker
            .addTo(map);

        // Example function to update marker position and location info
        function updatePosition(lng, lat) {
            marker.setLngLat([lng, lat]);
            document.querySelector('.location-info span').textContent = `Votre position: ${lng}, ${lat}`;
        }

        // Function to search for a location using OpenCage API
        async function searchLocation(query) {
            const apiKey = '6fbe06b1b8044fb18c9a61d3b703ee6d'; // Replace with your OpenCage API key
            const response = await fetch(`https://api.opencagedata.com/geocode/v1/json?q=${query}&key=${apiKey}`);
            const data = await response.json();
            return data.results;
        }

        // Function to display search results
        function displaySearchResults(results) {
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '';
            results.forEach(result => {
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';
                resultItem.textContent = result.formatted;
                resultItem.onclick = () => {
                    const { lat, lng } = result.geometry;
                    updateDestination(lat, lng, result.formatted);
                };
                searchResults.appendChild(resultItem);
            });
        }

        // Function to update destination marker and calculate route
        function updateDestination(lat, lng, address) {
            // Add marker for destination
            const destinationMarker = new mapboxgl.Marker({ color: 'red' })
                .setLngLat([lng, lat])
                .addTo(map);
            // Zoom out to fit both markers
            const bounds = new mapboxgl.LngLatBounds()
                .extend(marker.getLngLat())
                .extend(destinationMarker.getLngLat());
            map.fitBounds(bounds, { padding: 50 });

            // Calculate route using Mapbox Directions API
            calculateRoute(marker.getLngLat(), [lng, lat]);
        }

        // Function to calculate and display route
        async function calculateRoute(start, end) {
            const directionsRequest = `https://api.mapbox.com/directions/v5/mapbox/driving/${start.lng},${start.lat};${end[0]},${end[1]}?geometries=geojson&access_token=${mapboxgl.accessToken}`;
            const response = await fetch(directionsRequest);
            const data = await response.json();
            const route = data.routes[0].geometry.coordinates;
            const geojson = {
                type: 'Feature',
                properties: {},
                geometry: {
                    type: 'LineString',
                    coordinates: route
                }
            };

            // If the route already exists on the map, we'll reset it with the updated route
            if (map.getSource('route')) {
                map.getSource('route').setData(geojson);
            } else {
                map.addLayer({
                    id: 'route',
                    type: 'line',
                    source: {
                        type: 'geojson',
                        data: geojson
                    },
                    layout: {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    paint: {
                        'line-color': '#888',
                        'line-width': 6
                    }
                });
            }
        }

        document.getElementById('searchInput').addEventListener('input', async (event) => {
            const query = event.target.value;
            if (query.length > 3) {
                const results = await searchLocation(query);
                displaySearchResults(results);
            }
        });
    </script>
</body>
</html>
